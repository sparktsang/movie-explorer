<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikidata Movie Explorer</title>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f1014;
            --surface-dark: #1b1d24;
            --primary-red: #e50914; /* Cinematic Red */
            --text-main: #ffffff;
            --text-muted: #a3a3a3;
            --border-color: #333;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at top, #1f232f 0%, #0f1014 100%);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            min-height: 100vh;
        }

        /* GitHub Corner Link */
        .github-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: var(--text-muted);
            transition: color 0.3s;
        }
        .github-link:hover { color: var(--text-main); }
        .github-link svg { width: 30px; height: 30px; fill: currentColor; }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Typography */
        h1 {
            font-family: 'Oswald', sans-serif;
            text-transform: uppercase;
            font-size: 3rem;
            text-align: center;
            letter-spacing: 2px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #bbb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        /* Controls Panel */
        .controls {
            background: rgba(27, 29, 36, 0.8);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            align-items: end;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 40px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-family: 'Oswald', sans-serif;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select, input {
            background-color: #000;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 12px;
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Lato', sans-serif;
            outline: none;
            transition: border 0.3s;
        }

        select:focus, input:focus {
            border-color: var(--primary-red);
            position: relative;
            z-index: 10;
            box-shadow: 0 0 0 1px var(--primary-red);
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 15px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            flex: 1;
        }

        .btn-search {
            background: var(--primary-red);
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
        }
        .btn-search:hover { background: #ff1f1f; transform: translateY(-2px); }
        .btn-search:disabled { background: #444; cursor: not-allowed; box-shadow: none; transform: none; }

        .btn-download {
            background: #2e7d32;
            display: none; /* Hidden by default */
        }
        .btn-download:hover { background: #4caf50; transform: translateY(-2px); }

        /* Custom Checkbox */
        .checkbox-group {
            display: flex;
            align-items: center;
            height: 45px; /* Align with inputs */
            cursor: pointer;
        }
        .checkbox-group input {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            accent-color: var(--primary-red);
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: var(--primary-red);
        }
        .sub-label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            font-family: 'Lato', sans-serif;
            text-transform: none;
            margin-top: 2px;
        }

        /* Status Bar */
        #status {
            text-align: center;
            font-family: 'Oswald', sans-serif;
            color: var(--text-muted);
            margin-bottom: 20px;
            height: 24px;
            letter-spacing: 1px;
        }

        .table-container {
            overflow-x: auto; /* ÂÖÅË®±Ê©´ÂêëÊç≤Âãï */
            -webkit-overflow-scrolling: touch; /* ÊâãÊ©üÂπ≥ÊªëÊç≤Âãï */
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%; /* ‰ΩîÊªøÁà∂ÂÆπÂô® */
        }
        
        table {
            width: 100%;
            min-width: 1000px; /* <--- ÈóúÈçµÔºÅÂº∑Âà∂Ë°®Ê†ºÊúÄÂ∞ëË¶ÅÊúâÈÄôÈ∫ºÂØ¨ÔºåÂ∞±‰∏çÊúÉËÆäÂΩ¢ */
            border-collapse: collapse;
            background: var(--surface-dark);
            font-size: 0.95rem;
            /* ÁßªÈô§ table-layout: fixed; ËÆìÂÖßÂÆπËá™ÁÑ∂ÊíêÈñã */
        }

        /* [UPDATED] Cells */
        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid #2a2a2a;
            vertical-align: middle;
            color: #ddd;
            /* ÁßªÈô§ word-wrap: break-word; */
            white-space: normal; /* ÂÖÅË®±Ëá™ÁÑ∂ÊèõË°åÔºå‰ΩÜ‰∏çÂº∑Âà∂ÂàáÊñ∑ÂñÆÂ≠ó */
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background: #252830; }

        /* Column Specifics */
        .col-title { width: 30%; }
        .col-title a { 
            color: #fff; 
            font-weight: 700; 
            text-decoration: none; 
            font-size: 1.1rem;
            transition: color 0.2s;
        }
        .col-title a:hover { color: var(--primary-red); }

        .col-year { width: 8%; color: var(--text-muted); font-family: 'Oswald', sans-serif; }
        .col-country { width: 12%; }
        .col-lang { width: 10%; }
        .col-genre { width: 20%; font-size: 0.9em; color: var(--text-muted); }
        .col-duration { width: 8%; font-family: 'Oswald', sans-serif; color: var(--text-muted); }
        .col-score { width: 12%; font-family: 'Oswald', sans-serif; font-size: 1.1rem; }

        .score-val { 
            color: var(--primary-red); 
            text-decoration: none; 
            border-bottom: 1px dotted var(--primary-red); 
        }
        .score-val:hover { color: #ff5252; border-bottom: 1px solid #ff5252; }

        .review-count {
            font-size: 0.8rem;
            color: #666;
            margin-left: 6px;
            font-family: 'Lato', sans-serif;
            font-weight: 400;
        }

    </style>
</head>
<body>

    <a href="https://github.com/sparktsang/movie-explorer" target="_blank" class="github-link" title="View on GitHub">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
    </a>

    <div class="container">
        <h1>Wikidata Movie Explorer</h1>
        <p class="subtitle">Discover cinema through open data. No ads. No tracking.</p>

        <div class="controls">
            <div class="control-group">
                <label>From Year</label>
                <input type="number" id="year-start" value="2005" style="width: 100%;">
            </div>
            <div class="control-group">
                <label>To Year</label>
                <input type="number" id="year-end" value="2025" style="width: 100%;">
            </div>
            
            <div class="control-group">
                <label>Genre</label>
                <select id="genre">
                    <option value="">(Any)</option>
                    <option value="Q188473">Action</option>
                    <option value="Q319221">Adventure</option>
                    <option value="Q2447078">Alien Invasion</option>
                    <option value="Q202866">Animated</option>
                    <option value="Q47009776">Apocalyptic</option>
                    <option value="Q645928">Biographical</option>
                    <option value="Q5778924">Black Comedy</option>
                    <!-- UPDATED: Multi-ID Value -->
                    <option value="Q102260466,Q3641550">Body Horror</option>
                    <option value="Q157443">Comedy</option>
                    <option value="Q102429885">Coming-of-age</option>
                    <option value="Q959790">Crime</option>
                    <option value="Q846544">Disaster</option>
                    <option value="Q93204">Documentary</option>
                    <option value="Q130232">Drama</option>
                    <option value="Q20443008">Dystopian</option>
                    <option value="Q652256">Epic</option>
                    <option value="Q599558">Erotic</option>
                    <option value="Q1361932">Family</option>
                    <option value="Q157394">Fantasy</option>
                    <option value="Q200092">Horror</option>
                    <option value="Q1033891">Martial Arts</option>
                    <option value="Q842256">Musical</option>
                    <option value="Q1200678">Mystery</option>
                    <option value="Q2973201">Political</option>
                    <option value="Q590103">Psychological Thriller</option>
                    <option value="Q1054574">Romance</option>
                    <option value="Q471839">Sci-Fi</option> 
                    <option value="Q2973181">Speculative Fiction</option>
                    <option value="Q2297927">Spy</option>
                    <option value="Q1535153">Superhero</option>
                    <option value="Q15898171">Survival</option>
                    <option value="Q580850">Techno-thriller</option>
                    <option value="Q2484376">Thriller</option>
                    <option value="Q104765957">Time-travel</option>
                    <option value="Q369747">War</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Country</label>
                <select id="country">
                    <option value="">(Any)</option>
                    <option value="Q30">USA</option>
                    <option value="Q145">UK</option>
                    <option value="Q17">Japan</option>
                    <option value="Q884">South Korea</option>
                    <option value="Q865">Taiwan</option>
                    <option value="Q8646">Hong Kong</option>
                    <option value="Q148">China</option>
                    <option value="Q142">France</option>
                    <option value="Q183">Germany</option>
                    <option value="Q668">India</option>
                </select>
            </div>
            
            <div class="control-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="sort-rt">
                    <div>
                        <label for="sort-rt">Sort by Tomatometer</label>
                        <span class="sub-label">(Only shows rated movies)</span>
                    </div>
                </div>
            </div>

            <div class="btn-row" style="flex-grow: 1; min-width: 200px;">
                <button onclick="fetchData()" class="btn-search" id="search-btn">Search</button>
                <button onclick="downloadExcel()" class="btn-download" id="download-btn">Export .XLSX</button>
            </div>
        </div>
        
        <div id="status"></div>

        <div style="text-align: center; margin-bottom: 20px;">
            <a id="debug-link" href="#" target="_blank" style="color: #666; font-size: 0.8rem; text-decoration: none; border-bottom: 1px dashed #666; display: none;">
                üêõ View Raw Query on Wikidata
            </a>
        </div>

        <div class="table-container">
            <table id="results-table">
                <thead>
                    <tr>
                        <th class="col-title">Title</th>
                        <th class="col-year">Year</th>
                        <th class="col-country">Country</th>
                        <th class="col-lang">Language</th>
                        <th class="col-genre">Genre</th>
                        <th class="col-duration">Duration</th>
                        <th class="col-score">RT Score</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const ENDPOINT = "https://query.wikidata.org/sparql";
        let globalMovieData = [];

        async function fetchData() {
            const btnSearch = document.getElementById('search-btn');
            const btnDownload = document.getElementById('download-btn');
            const status = document.getElementById('status');
            const tbody = document.querySelector("#results-table tbody");
            
            btnSearch.disabled = true;
            btnDownload.style.display = 'none';
            status.innerText = "Scanning Wikidata...";
            tbody.innerHTML = "";
            globalMovieData = [];

            const yStart = document.getElementById('year-start').value;
            const yEnd = document.getElementById('year-end').value;
            const genre = document.getElementById('genre').value;
            const country = document.getElementById('country').value;
            const sortByRT = document.getElementById('sort-rt').checked;

            // --- SPARQL GENERATION ---
            
            // 1. Handle Genre Logic (Fixing the Animation Ontology Issue)
            let genreFilter = "";
            if (genre) {
                if (genre === "Q202866") {
                    // Animation Special Case: Check P136 (Genre) OR P31 (Instance Of)
                    genreFilter = `{ ?item wdt:P136 wd:Q202866. } UNION { ?item wdt:P31/wdt:P279* wd:Q202866. }`;
                } else if (genre.includes(',')) {
                    // Multi-ID case
                    const ids = genre.split(',').map(id => `wd:${id}`).join(', ');
                    genreFilter = `?item wdt:P136 ?g. FILTER(?g IN (${ids}))`;
                } else {
                    // Standard case
                    genreFilter = `?item wdt:P136 wd:${genre}.`;
                }
            }

            // 2. Score Logic
            const scoreBlock = `
                ?item p:P444 ?statement.
                ?statement ps:P444 ?rtScore;
                           pq:P447 wd:Q105584;     
                           pq:P459 wd:Q108403393.
                OPTIONAL { ?statement pq:P7887 ?reviewCount. }
            `;
            const scoreQuery = sortByRT ? scoreBlock : `OPTIONAL { ${scoreBlock} }`;

            const sparql = `
                SELECT DISTINCT 
                  ?item 
                  ?article 
                  ?minDate
                  (SAMPLE(?itemLabel) as ?title)
                  (GROUP_CONCAT(DISTINCT ?countryLabel; separator=", ") as ?countries)
                  (GROUP_CONCAT(DISTINCT ?langLabel; separator=", ") as ?languages)
                  (GROUP_CONCAT(DISTINCT ?genreLabel; separator=", ") as ?genres)
                  (SAMPLE(?duration) as ?runtime)
                  (SAMPLE(?rtScore) as ?score)
                  (SAMPLE(?reviewCount) as ?count)
                  (SAMPLE(?rtId) as ?rottenId)
                WHERE {
                  {
                    SELECT ?item (MIN(?pubDate) as ?minDate) WHERE {
                      
                      # ÈÄô‰∏ÄË°å‰øùÊåÅ‰∏çËÆä (ÂåÖÂê´ Subclass ‰øÆÊ≠£)
                      ?item wdt:P31/wdt:P279* wd:Q11424; wdt:P577 ?pubDate.
                      
                      # --- [‰øÆÊ≠£ÈÄôË£°] ---
                      # Ëàä: ${genre ? `?item wdt:P136 wd:${genre}.` : ''}
                      # Êñ∞: ‰ΩøÁî®‰∏äÈù¢ÂÆöÁæ©Â•ΩÁöÑ genreFilter ËÆäÊï∏
                      
                      ${genreFilter}
                      
                      # ------------------
                      
                      ${country ? `?item wdt:P495 wd:${country}.` : ''}
                    }
                    GROUP BY ?item
                  }
                  
                  FILTER((YEAR(?minDate)) >= ${yStart} && (YEAR(?minDate)) <= ${yEnd})

                  OPTIONAL { ?item wdt:P495 ?country. }
                  OPTIONAL { ?item wdt:P364 ?lang. }
                  OPTIONAL { 
                    { ?item wdt:P136 ?genre. }
                    UNION
                    { 
                        ?item wdt:P31 ?genre. 
                        FILTER(?genre = wd:Q202866)
                    } 
                  }
                  OPTIONAL { ?item wdt:P2047 ?duration. }
                  OPTIONAL { ?item wdt:P1258 ?rtId. } 

                  OPTIONAL {
                    ?article schema:about ?item .
                    ?article schema:isPartOf <https://en.wikipedia.org/> .
                  }

                  ${scoreQuery}

                  SERVICE wikibase:label { 
                    bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". 
                    ?item rdfs:label ?itemLabel.
                    ?country rdfs:label ?countryLabel.
                    ?lang rdfs:label ?langLabel.
                    ?genre rdfs:label ?genreLabel.
                  }
                }
                GROUP BY ?item ?article ?minDate
                ORDER BY DESC(?minDate)
                LIMIT 1000
            `;
            
            // ... (sparql variable definition above)

            // --- DEBUG FEATURE ---
            const debugLink = document.getElementById('debug-link');
            const encodedQuery = encodeURIComponent(sparql);
            debugLink.href = `https://query.wikidata.org/#${encodedQuery}`;
            debugLink.style.display = 'inline-block';
            
            // ... (try { fetch... } below)

            try {
                const url = `${ENDPOINT}?query=${encodeURIComponent(sparql)}&format=json`;
                const response = await fetch(url, { headers: { 'Accept': 'application/sparql-results+json' } });
                
                if (!response.ok) throw new Error("Network response error");

                const data = await response.json();
                let results = data.results.bindings;

                if (sortByRT) {
                    results.sort((a, b) => {
                        const scoreA = parseScore(a.score ? a.score.value : "0");
                        const scoreB = parseScore(b.score ? b.score.value : "0");
                        
                        // Primary: Score
                        if (scoreA !== scoreB) return scoreB - scoreA;

                        // Secondary: Review Count
                        const countA = parseCount(a.count ? a.count.value : "0");
                        const countB = parseCount(b.count ? b.count.value : "0");
                        return countB - countA;
                    });
                }

                if (results.length === 0) {
                    status.innerText = "No movies found.";
                } else {
                    renderTable(results);
                    status.innerText = `Found ${results.length} movies.`;
                    btnDownload.style.display = 'inline-block';
                }

            } catch (error) {
                console.error(error);
                status.innerText = "Error: " + error.message;
            } finally {
                btnSearch.disabled = false;
            }
        }

        function parseScore(scoreStr) {
            if (!scoreStr || scoreStr === "-") return -1;
            if (scoreStr.includes('%')) {
                return parseInt(scoreStr.replace('%', ''));
            } else if (scoreStr.includes('/')) {
                let parts = scoreStr.split('/');
                return (parseFloat(parts[0]) / parseFloat(parts[1])) * 100;
            }
            return 0;
        }

        function parseCount(countStr) {
            const nums = countStr.replace(/[^0-9]/g, '');
            return nums ? parseInt(nums) : 0;
        }

        function renderTable(results) {
            const tbody = document.querySelector("#results-table tbody");
            const seenIds = new Set();

            results.forEach(row => {
                const id = row.item.value;
                if (seenIds.has(id)) return;
                seenIds.add(id);

                // --- [UPDATED] Smart Title Logic ---
                // 1. Get raw label from Wikidata (might be Q-ID)
                let rawTitle = row.title ? row.title.value : "Unknown";
                
                // 2. Check if it looks like a Q-ID (e.g. Q125971387)
                //    Regex explanation: Starts with Q, followed by numbers only
                const isQID = /^Q\d+$/.test(rawTitle);
                
                // 3. If it is a Q-ID AND we have a Wikipedia link, extract the real title from URL
                if (isQID && row.article) {
                    const wikiUrl = row.article.value; // e.g. https://en.wikipedia.org/wiki/Bugonia_(film)
                    const slug = wikiUrl.split('/').pop(); // Get "Bugonia_(film)"
                    
                    // Decode URL (remove %20 etc) and replace underscores with spaces
                    let cleanSlug = decodeURIComponent(slug).replace(/_/g, ' '); // "Bugonia (film)"
                    
                    // Remove trailing parentheses like (film) or (2025 film)
                    // Regex looks for space + ( + anything + film + ) at the end
                    cleanSlug = cleanSlug.replace(/\s\([^)]*film\)$/i, ''); // "Bugonia"

                    rawTitle = cleanSlug;
                }
                
                const title = rawTitle;
                // -----------------------------------
                const date = row.minDate ? row.minDate.value.substring(0, 4) : "-";
                
                let country = row.countries ? row.countries.value : "-";
                country = country.replace("People's Republic of China", "China");

                const lang = row.languages ? row.languages.value : "-";
                
                let genreText = row.genres ? row.genres.value : "-";
                genreText = genreText.replace(/ film/gi, ""); 

                let durationRaw = row.runtime ? Math.round(parseFloat(row.runtime.value)) : "";
                let durationStr = durationRaw ? durationRaw + " min" : "-";

                let scoreStr = "-";
                let reviewCountStr = "";
                let rtUrl = "";

                if (row.score) {
                    scoreStr = row.score.value;
                    const c = row.count ? row.count.value : "";
                    const cleanCount = c.replace(/[^0-9]/g, '');
                    reviewCountStr = cleanCount ? `(${cleanCount})` : "";
                    
                    if (row.rottenId) {
                        let rid = row.rottenId.value;
                        // URL Logic: Assume ID does NOT have /m/ prefix unless verified otherwise, 
                        // but if user says it includes it, we handle that.
                        // Standard RT IDs in Wikidata (P1258) are usually slugs "movie_name"
                        // But some might be "m/movie_name". 
                        // Safer logic: remove leading slash/m/ if present, then add /m/
                        // Actually, user said: "ID itself includes /m". So we prepend nothing?
                        // Let's ensure a valid URL structure.
                        // If id is "m/movie", url is domain.com/m/movie.
                        // If id is "movie", url is domain.com/m/movie.
                        // Let's assume user is right about P1258 data often containing the path.
                        
                        if (!rid.startsWith('/') && !rid.startsWith('m/')) {
                             rtUrl = `https://www.rottentomatoes.com/m/${rid}`;
                        } else {
                             // Handle existing path
                             rtUrl = `https://www.rottentomatoes.com${rid.startsWith('/') ? '' : '/'}${rid}`;
                        }
                    }
                }
                
                const wikiLink = row.article ? row.article.value : row.item.value;

                globalMovieData.push({
                    Title: title,
                    Year: date,
                    Country: country,
                    Language: lang,
                    Genre: genreText,
                    Duration: durationRaw,
                    Tomatometer: scoreStr,
                    ReviewCount: reviewCountStr.replace(/[()]/g, ''),
                    WikiLink: wikiLink,
                    RTLink: rtUrl
                });

                let scoreHtml = scoreStr;
                if (rtUrl && scoreStr !== "-") {
                    scoreHtml = `<a href="${rtUrl}" target="_blank" class="score-val">${scoreStr}</a>`;
                }
                if (reviewCountStr) {
                    scoreHtml += ` <span class="review-count">${reviewCountStr}</span>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-title"><a href="${wikiLink}" target="_blank">${title}</a></td>
                    <td class="col-year">${date}</td>
                    <td class="col-country">${country}</td>
                    <td class="col-lang">${lang}</td>
                    <td class="col-genre">${genreText}</td>
                    <td class="col-duration">${durationStr}</td>
                    <td class="col-score">${scoreHtml}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function downloadExcel() {
            if (globalMovieData.length === 0) return;
            const worksheet = XLSX.utils.json_to_sheet(globalMovieData);
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                const rowIndex = R - 1;
                const rowData = globalMovieData[rowIndex];
                
                // Hyperlinks
                const cellTitle = XLSX.utils.encode_cell({r: R, c: 0});
                if (rowData.WikiLink) {
                    worksheet[cellTitle].l = { Target: rowData.WikiLink };
                }

                const cellRT = XLSX.utils.encode_cell({r: R, c: 6});
                if (rowData.RTLink) {
                    if (!worksheet[cellRT]) worksheet[cellRT] = { t: 's', v: rowData.Tomatometer };
                    worksheet[cellRT].l = { Target: rowData.RTLink };
                }
            }

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Movies");
            XLSX.writeFile(workbook, "wikidata_movies.xlsx");
        }
    </script>
</body>
</html>
